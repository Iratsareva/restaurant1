<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö - –†–µ—Å—Ç–æ—Ä–∞–Ω</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        #status {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            color: #dc3545;
            background-color: #f8d7da;
        }

        #status.connected {
            color: #155724;
            background-color: #d4edda;
        }
        .notification {
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid;
            border-radius: 4px;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .notification.created {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .notification.priced {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .notification.priced.good {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .notification.priced.bad {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

                .notification.deleted {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .notification-body {
            font-size: 0.95em;
            line-height: 1.6;
        }
        .timestamp {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
        }
    </style>
</head>


<body>
<div class="container">
    <h2>üîî –¶–µ–Ω—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö</h2>
    <div id="status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
    <div id="notifications-area"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const area = document.getElementById('notifications-area');
    let socket = null;
    let reconnectAttempts = 0;
    let reconnectTimer = null;
    let pingInterval = null;
    const MAX_RECONNECT_DELAY = 30000; // –º–∞–∫—Å. 30 —Å–µ–∫ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

    function connect() {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
        if (socket && socket.readyState === WebSocket.CONNECTING) {
            return;
        }

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }

           // ws:// –¥–ª—è http, wss:// –¥–ª—è https (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(`${protocol}//localhost:8083/ws/notifications`);

        socket.onopen = function() {
            reconnectAttempts = 0; // —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            statusDiv.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–∏—Å—Ç–µ–º–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π';
            statusDiv.className = 'connected';

            // –ó–∞–ø—É—Å–∫–∞–µ–º Ping –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è keep-alive
            pingInterval = setInterval(() => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send('PING');
                }
            }, 10000);
        };

        socket.onmessage = function(event) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º PONG –æ—Ç–≤–µ—Ç—ã
            if (event.data === 'PONG') {
                return;
            }

            try {
                const data = JSON.parse(event.data);
                console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ:", data);
                showNotification(data);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e);
            }
        };


           socket.onclose = function(event) {
            statusDiv.textContent = '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            statusDiv.className = '';

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Ping
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }

            scheduleReconnect();
        };

        socket.onerror = function() {
            console.error('–û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        };
    }

    function scheduleReconnect() {
        // Exponential backoff: 1s, 2s, 4s, 8s... –¥–æ MAX_RECONNECT_DELAY
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY);
        reconnectAttempts++;

        statusDiv.textContent = `–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay/1000} —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts})...`;
        reconnectTimer = setTimeout(connect, delay);
    }


    function showNotification(data) {
        const div = document.createElement('div');
        div.className = 'notification';

        let header = '';
        let body = '';
        let timestamp = new Date().toLocaleString('ru-RU');

        if (data.type === 'RESERVATION_CREATED') {
            div.className += ' created';
            header = '‚úÖ –ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ';
            body = `
                <strong>ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${data.reservationId}<br>
                <strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${data.clientName} (ID: ${data.clientId})<br>
                <strong>–°—Ç–æ–ª:</strong> ${data.tableNumber} (ID: ${data.tableId})<br>
                <strong>–í—Ä–µ–º—è:</strong> ${new Date(data.reservationTime).toLocaleString('ru-RU')}<br>
                <strong>–ì–æ—Å—Ç–µ–π:</strong> ${data.numberOfGuests}
            `;
        } else if (data.type === 'RESERVATION_PRICED') {
            div.className += ' priced ' + data.verdict.toLowerCase();
            header = 'üí∞ –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞';
            body = `
                <strong>ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${data.reservationId}<br>
                <strong>–¶–µ–Ω–∞:</strong> ${data.price.toFixed(2)} ‚ÇΩ<br>
                <strong>–í–µ—Ä–¥–∏–∫—Ç:</strong> ${data.verdict === 'GOOD' ? '‚úÖ –•–æ—Ä–æ—à–∞—è —Ü–µ–Ω–∞' : '‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è —Ü–µ–Ω–∞'}
            `;
        } else if (data.type === 'RESERVATION_DELETED') {
            div.className += ' deleted';
            header = 'üóëÔ∏è –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ';
            body = `
                <strong>ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${data.reservationId}
            `;
        }


    div.innerHTML = `
            <div class="notification-header">${header}</div>
            <div class="notification-body">${body}</div>
            <div class="timestamp">${timestamp}</div>
        `;

        area.prepend(div); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    connect();
</script>
</body>
</html>